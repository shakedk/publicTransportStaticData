$(document).ready(function(){function e(e){return{weight:.5,opacity:.5,color:"black",fillOpacity:.7,fillColor:b(e.properties.styleHash)}}function t(){f.eachLayer(function(t){t.setStyle(e(t.feature))})}function a(e,t){var a=e.properties.Name;t._leaflet_id=a,t.on({contextmenu:n})}function n(e){parLineHightlight(e);var t=e.target;m.setLatLng(e.latlng),m.setContent('<div class="marker-title">Area ID: '+t.feature.properties.Name+" TAI: "+t.feature.properties.styleHash+"</div>"),m._map||m.openOn(g),t.setStyle({weight:2,opacity:.3,fillOpacity:.9}),L.Browser.ie||L.Browser.opera||t.bringToFront()}function r(e){return 10>e?"0"+e:e}var o=!1;draw_areas_and_lines=function(e,t){e="undefined"==typeof e?"06":e,t="undefined"==typeof t?"09":t,draw_areas_on_map(e,t),draw_par_coords()},$("#slider").dateRangeSlider({bounds:{min:new Date(2013,0,1),max:new Date(2013,0,1,23,59,59)},defaultValues:{min:new Date(2013,0,1,6),max:new Date(2013,0,1,9)},formatter:function(e){var t=e.getHours(),a=e.getMinutes();return r(t)+":"+r(a)},step:{minutes:60}}).bind("valuesChanged",function(e,t){draw_areas_and_lines(t.values.min.getHours(),t.values.max.getHours())});var s,l="localhost",p=d3.parcoords()("#parallelCoords"),c=["rgb(129, 16, 237)","rgb(45, 85, 253)","rgb(6, 155, 221)","rgb(0, 192, 191)","rgb(8, 226, 148)","rgb(112, 245, 26)","rgb(196, 187, 0)","rgb(232, 139, 12)","rgb(254, 75, 53)","rgb(238, 17, 128)"],u="rgba(255,0,0,0)",d=L.tileLayer("https://api.mapbox.com/v4/mapbox.streets/{z}/{x}/{y}.png?access_token={token}",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',mapId:"mapbox-streets",token:"pk.eyJ1Ijoic2hha2VkayIsImEiOiJjaWxjYzVxbzIwMDZud2dsejg3Zmw3dncyIn0.1mxg8ZqXNXzMZ2OkH9os5A"}),g=L.map("map").addLayer(d).setView([32.087917,34.795551],13.5),m=new L.Popup({autoPan:!1});L.svg().addTo(g);var f,h=d3.select(g.getPanes().overlayPane).append("svg");h.append("g").attr("class","leaflet-zoom-hide");draw_areas_on_map=function(n,r){return n===r?void alert("Please select an interval of at least two hours"):void d3.json("http://"+l+":8080/areas/"+n+"/"+r,function(n){"undefined"!=typeof f?(y(n),o?onBrushEvent(x):t()):f=L.geoJson(n,{style:e,onEachFeature:a}).addTo(g)})},g.on("click",function(e){p.unhighlight()});var y=function(e){var t,a,n=new Map;for(i=0;i<e.features.length;i++)t=e.features[i].properties.Name,a=e.features[i].properties.styleHash,n.set(t,a);f.eachLayer(function(e){e.feature.properties.styleHash=n.get(e._leaflet_id)})},b=function(e){return e>=0&&e<=c.length?c[e]:u};g.on("click",function(e){p.unhighlight()});var v=L.control({position:"bottomright"});v.onAdd=function(e){var t=L.DomUtil.create("div","legend");return t.innerHTML+='<p style="margin:auto; background: linear-gradient(to right, '+c+')"</p><br>',t.innerHTML+='<p style="font: 25px bold"> Lowest Accessibility &#8596 Highest Accessibility</p>',t},v.addTo(g),draw_par_coords=function(){d3.json("http://"+l+":8080/areaPcProperties/",function(e){s=e;var t=function(t){return range=p.height()-p.margin().top-p.margin().bottom,min=d3.min(e,function(e){return parseInt(e[t])}),max=d3.max(e,function(e){return parseFloat(e[t])}),d3.scale.sqrt().clamp(!0).domain([min,max]).range([range,1])},a=function(t){return range=p.height()-p.margin().top-p.margin().bottom,min=d3.min(e,function(e){return parseInt(e[t])}),max=d3.max(e,function(e){return 1.2}),d3.scale.linear().clamp(!0).domain([min,max]).range([range,1])},n={numberOfStopsInArea:{title:"Stops in Zone",yscale:t("numberOfStopsInArea")},shapeArea:{title:"Area (km^2)",yscale:a("shapeArea")},population:{title:"Population",yscale:t("population")},averageFrequencies:{title:"ZAF"},tai:{title:"TAI",tickValues:[0,1,2,3,4,5,6,7,8,9,10]},medianIncome:{title:"Median Income",ticks:6}},r=function(e){return b(Math.floor(e.tai))};e=e.filter(function(e){return parseFloat(e.tai)>=0}),p.data(e).color(r).dimensions(n).detectDimensions().hideAxis(["areaID"]).render().alpha(.5).render().shadows().reorderable().composite("darken").margin({top:24,left:150,bottom:12,right:0}).mode("queue").render().brushMode("1D-axes").updateAxes(),p.svg.selectAll("text").style("font","25px sans-serif").style("font-weight","bold"),p.svg.attr("transform","translate(90,24)"),p.svg.attr("margin-bottom","20px"),p.svg.selectAll(".dimension text.label").style("color","red"),onBrushEvent=function(e){x=e,o=!0,f&&(f.setStyle({fillOpacity:.1}),e.forEach(function(e){selectPolygon=f.getLayer(e.areaID),setAreaHighlighted(selectPolygon)}))},p.on("brush",onBrushEvent)})},parLineHightlight=function(e){lineToHighlight=s.filter(function(t){return""+t.areaID===e.target.feature.properties.Name}),lineToHighlight[0].medianIncome>0&&p.highlight(lineToHighlight)},setAreaHighlighted=function(e){e.setStyle({fillOpacity:1,fillColor:b(e.feature.properties.styleHash)})};var x;draw_areas_and_lines()});